graph TD
    %% Main Entry Points
    A1[ReplicasOverride Reconciliation] --> B1{Fetch ReplicasOverride}
    A2[Deployment Watch] --> B2[findReplicasOverridesForDeployment]
    A3[HPA Watch] --> B3[findReplicasOverridesForHPA]

    %% ReplicasOverride Flow
    B1 -->|Not Found| C1{Try Global Config}
    B1 -->|Found| D1[Initialize Status]
    
    C1 -->|Get Deployment| E1[Check Ignore Rules]
    E1 -->|Not Ignored| F1[Process with Global Config]
    E1 -->|Ignored| G1[Return]
    
    D1 --> H1{Check Reference Type}
    H1 -->|DeploymentRef| I1[Get Single Deployment]
    H1 -->|Selector| J1[List Matching Deployments]
    
    I1 --> K1[Process Deployments]
    J1 --> K1
    
    %% Deployment Processing
    K1 --> L1{For Each Deployment}
    L1 --> M1{Should Process?}
    M1 -->|No| L1
    M1 -->|Yes| N1{Check Ignore Rules}
    
    N1 -->|Ignored| L1
    N1 -->|Not Ignored| O1[Store Original State]
    
    O1 --> P1[Process Deployment]
    F1 --> P1
    
    P1 --> Q1[Initialize Annotations]
    Q1 --> R1[Get Global Config]
    R1 --> S1[Calculate Target Replicas]
    
    S1 --> T1[Apply Min/Max Limits]
    T1 --> U1[Update Deployment]
    
    U1 --> V1[Process Associated HPA]
    V1 --> W1[Record Affected Deployment]
    
    %% HPA Processing
    V1 --> X1[Initialize HPA Annotations]
    X1 --> Y1[Calculate Target Min/Max]
    Y1 --> Z1[Apply Global Limits]
    Z1 --> AA1[Update HPA]
    
    %% Status Updates
    W1 --> BB1[Update Override Status]
    BB1 --> CC1[Requeue After 5min]
    
    %% Annotations
    subgraph "Deployment Annotations"
        AN1[original-replicas]
        AN2[override-controller]
        AN3[managed]
        AN4[global-config-managed]
        AN5[last-update]
    end
    
    subgraph "HPA Annotations"
        HAN1[hpa-original-min]
        HAN2[hpa-original-max]
        HAN3[hpa-managed]
        HAN4[last-hpa-update]
    end
    
    %% Global Config
    subgraph "Global Configuration"
        GC1[Global Percentage]
        GC2[Max Replicas]
        GC3[Min Replicas]
    end
    
    %% Watch Handlers
    subgraph "Watch Handlers"
        WH1[Check Ignore Rules]
        WH2[Find Matching Overrides]
        WH3[Create Global Config Request]
    end

    style A1 fill:#f9f,stroke:#333,stroke-width:2px
    style A2 fill:#f9f,stroke:#333,stroke-width:2px
    style A3 fill:#f9f,stroke:#333,stroke-width:2px